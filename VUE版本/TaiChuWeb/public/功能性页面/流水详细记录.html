<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>太初寰宇 | 财务流水详细记录</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
      position: relative;
    }
    
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top right, rgba(255, 193, 7, 0.1), transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
      position: relative;
      z-index: 1;
    }
    
    .back-button {
      display: inline-flex;
      align-items: center;
      padding: 12px 25px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      text-decoration: none;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 500;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: absolute;
      top: 20px;
      left: 20px;
    }
    
    .back-button:hover {
      background: rgba(255, 193, 7, 0.2);
      transform: translateY(-3px);
    }
    
    .back-button i {
      margin-right: 8px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeInDown 1s ease forwards;
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .header h1 {
      font-size: 2.8rem;
      margin-bottom: 15px;
      color: #ffc107;
      text-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
      letter-spacing: 1px;
    }
    
    .header p {
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.8);
      max-width: 800px;
      margin: 0 auto;
      line-height: 1.6;
    }
    
    .filter-bar {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: space-between;
      align-items: flex-end;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 8px;
      color: #ffc107;
      font-weight: 500;
    }
    
    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 12px 15px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
    }
    
    .filter-group input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    .filter-group select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
    }
    
    .filter-buttons {
      display: flex;
      gap: 15px;
      width: 100%;
      margin-top: 10px;
    }
    
    .filter-btn {
      padding: 10px 25px;
      background: rgba(255, 193, 7, 0.15);
      border: none;
      border-radius: 8px;
      color: #ffc107;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
    }
    
    .filter-btn:hover {
      background: rgba(255, 193, 7, 0.25);
      transform: translateY(-2px);
    }
    
    .filter-btn.reset {
      background: rgba(255, 0, 0, 0.15);
      color: rgba(255, 100, 100, 1);
    }
    
    .filter-btn.reset:hover {
      background: rgba(255, 0, 0, 0.25);
    }
    
    .stats-bar {
      display: flex;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 25px;
    }
    
    .stat-item {
      text-align: center;
      flex: 1;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #4fc3f7;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .data-table-container {
      overflow-x: auto;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 1000px;
    }
    
    .data-table thead {
      background: rgba(255, 193, 7, 0.1);
    }
    
    .data-table th {
      padding: 18px 15px;
      text-align: left;
      font-weight: 600;
      color: #ffc107;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: sticky;
      top: 0;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .data-table th:hover {
      background: rgba(255, 193, 7, 0.2);
    }
    
    .data-table th i {
      margin-left: 5px;
      opacity: 0.5;
    }
    
    .data-table tbody tr {
      transition: background 0.3s;
    }
    
    .data-table tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }
    
    .data-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    
    .data-table td {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.9);
    }
    
    .income {
      color: #50fa7b;
    }
    
    .expense {
      color: #ff5555;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 30px;
      padding: 15px 0;
      gap: 10px;
    }
    
    .pagination button {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .pagination button:hover {
      background: rgba(255, 193, 7, 0.15);
    }
    
    .pagination button.active {
      background: rgba(255, 193, 7, 0.25);
      color: #ffc107;
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .footer {
      text-align: center;
      margin-top: 60px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.95rem;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #4fc3f7;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    @media (max-width: 1200px) {
      .container {
        padding: 30px 15px;
      }
      
      .header h1 {
        font-size: 2.4rem;
      }
    }
    
    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
      }
      
      .filter-group {
        min-width: 100%;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .header p {
        font-size: 1rem;
      }
      
      .stat-value {
        font-size: 1.6rem;
      }
    }
    
    @media (max-width: 480px) {
      .filter-buttons {
        flex-direction: column;
      }
      
      .pagination button {
        width: 30px;
        height: 30px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <a href="#" class="back-button" id="back-button">
    <i class="fas fa-arrow-left"></i> 返回
  </a>
  
  <div class="container">
    <div class="header">
      <h1>财务流水详细记录</h1>
      <p>太初寰宇公司所有财务交易记录的详细查询，可按多种条件筛选和排序</p>
    </div>
    
    <div class="filter-bar">
      <div class="filter-group">
        <label for="search">搜索</label>
        <input type="text" id="search" placeholder="输入关键词搜索...">
      </div>
      
      <div class="filter-group">
        <label for="payer">支出人</label>
        <select id="payer">
          <option value="">全部支出人</option>
          <option value="管理员">管理员</option>
          <option value="财务部">财务部</option>
          <option value="项目A组">项目A组</option>
          <option value="项目B组">项目B组</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="receiver">收款人</label>
        <select id="receiver">
          <option value="">全部收款人</option>
          <option value="客户">客户</option>
          <option value="供应商">供应商</option>
          <option value="员工">员工</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="type">交易类型</label>
        <select id="type">
          <option value="">全部类型</option>
          <option value="收入">收入</option>
          <option value="支出">支出</option>
        </select>
      </div>
      
      <div class="filter-buttons">
        <button class="filter-btn" id="apply-filter"><i class="fas fa-filter"></i> 应用筛选</button>
        <button class="filter-btn reset" id="reset-filter"><i class="fas fa-redo"></i> 重置筛选</button>
        <button class="filter-btn" id="export-data"><i class="fas fa-file-export"></i> 导出数据</button>
      </div>
    </div>
    
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="total-income">
          <div class="loading-text">
            <span class="loading"></span> 加载中
          </div>
        </div>
        <div class="stat-label">总收入</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-value" id="total-expense">
          <div class="loading-text">
            <span class="loading"></span> 加载中
          </div>
        </div>
        <div class="stat-label">总支出</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-value" id="net-income">
          <div class="loading-text">
            <span class="loading"></span> 加载中
          </div>
        </div>
        <div class="stat-label">净利润</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-value" id="total-records">
          <div class="loading-text">
            <span class="loading"></span> 加载中
          </div>
        </div>
        <div class="stat-label">交易总数</div>
      </div>
    </div>
    
    <div class="data-table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th data-sort="id">序号 <i class="fas fa-sort"></i></th>
            <th data-sort="payer">支出人 <i class="fas fa-sort"></i></th>
            <th data-sort="project">收款项目 <i class="fas fa-sort"></i></th>
            <th data-sort="date">支出时间 <i class="fas fa-sort"></i></th>
            <th data-sort="receiver">收款人 <i class="fas fa-sort"></i></th>
            <th data-sort="amount">金额 <i class="fas fa-sort"></i></th>
            <th data-sort="type">类型 <i class="fas fa-sort"></i></th>
          </tr>
        </thead>
        <tbody id="records-body">
          <!-- 数据将通过JavaScript填充 -->
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div class="loading-text">
                <span class="loading"></span> 数据加载中...
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      
      <div class="pagination" id="pagination-controls">
        <button id="first-page" disabled><i class="fas fa-angle-double-left"></i></button>
        <button id="prev-page" disabled><i class="fas fa-angle-left"></i></button>
        <button class="active">1</button>
        <button id="next-page" disabled><i class="fas fa-angle-right"></i></button>
        <button id="last-page" disabled><i class="fas fa-angle-double-right"></i></button>
      </div>
    </div>
    
    <div class="footer">
      <p>© 2025 太初寰宇 · 数据最后更新时间: <span id="update-time">加载中...</span></p>
      <p>当前显示记录: <span id="record-range">0-0</span> 条，共 <span id="total-records-footer">0</span> 条记录 </p>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 页面状态变量
      let currentPage = 1;
      const recordsPerPage = 15;
      let totalRecords = 0;
      let totalPages = 1;
      let currentSort = { field: 'date', direction: 'desc' };
      
      // 初始化
      fetchFinancialSummary();
      fetchFinancialRecords();
      
      // 返回按钮功能
      document.getElementById('back-button').addEventListener('click', function(e) {
        e.preventDefault();
        window.history.back();
      });
      
      // 获取财务概览数据
      function fetchFinancialSummary() {
        fetch('/api/financial/summary')
          .then(response => {
            if (!response.ok) throw new Error('财务概览数据获取失败');
            return response.json();
          })
          .then(data => {
            // 更新统计栏
            document.getElementById('total-income').textContent = `¥${formatCurrency(data.total_income)}`;
            document.getElementById('total-expense').textContent = `¥${formatCurrency(data.total_expense)}`;
            document.getElementById('net-income').textContent = `¥${formatCurrency(data.net_income)}`;
            document.getElementById('total-records').textContent = data.total_records;
            
            // 更新页脚
            document.getElementById('update-time').textContent = data.update_time;
          })
          .catch(error => {
            console.error('获取财务概览失败:', error);
            document.getElementById('total-income').textContent = '加载失败';
            document.getElementById('total-expense').textContent = '加载失败';
            document.getElementById('net-income').textContent = '加载失败';
            document.getElementById('total-records').textContent = '加载失败';
            document.getElementById('update-time').textContent = '加载失败';
          });
      }
      
      // 获取财务详细记录
      function fetchFinancialRecords() {
        const search = document.getElementById('search').value;
        const payer = document.getElementById('payer').value;
        const receiver = document.getElementById('receiver').value;
        const type = document.getElementById('type').value;
        
        // 显示加载状态
        const tbody = document.getElementById('records-body');
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              <div class="loading-text">
                <span class="loading"></span> 数据加载中...
              </div>
            </td>
          </tr>
        `;
        
        // 构建查询参数
        const params = new URLSearchParams({
          page: currentPage,
          limit: recordsPerPage,
          search: search || '',
          payer: payer || '',
          receiver: receiver || '',
          type: type || '',
          sort: currentSort.field,
          order: currentSort.direction
        });
        
        fetch(`/api/financial/financialtable`)
          .then(response => {
            if (!response.ok) throw new Error('财务记录数据获取失败');
            return response.json();
          })
          .then(data => {
            // 更新分页信息
            currentPage = data.pagination.current_page;
            totalPages = data.pagination.total_pages;
            totalRecords = data.pagination.total_records;
            
            // 渲染表格
            renderFinancialTable(data.data);
            
            // 更新页脚信息
            updateFooterInfo(data.pagination);
            
            // 渲染分页控件
            renderPaginationControls(data.pagination);
          })
          .catch(error => {
            console.error('获取财务记录失败:', error);
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: #ff5555;">
                  数据加载失败，请稍后重试
                </td>
              </tr>
            `;
          });
      }
      
      // 渲染财务表格
      function renderFinancialTable(records) {
        const tbody = document.getElementById('records-body');
        tbody.innerHTML = '';
        
        if (records.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px;">
                未找到匹配的记录
              </td>
            </tr>
          `;
          return;
        }
        
        records.forEach(record => {
          const row = document.createElement('tr');
          const isIncome = record.type === '收入';
          
          row.innerHTML = `
            <td>${record.id}</td>
            <td>${record.payer}</td>
            <td>${record.project}</td>
            <td>${formatDate(record.date)}</td>
            <td>${record.receiver}</td>
            <td class="${isIncome ? 'income' : 'expense'}">
              ${isIncome ? '+' : '-'}¥${formatCurrency(record.amount)}
            </td>
            <td class="${isIncome ? 'income' : 'expense'}">${record.type}</td>
          `;
          
          tbody.appendChild(row);
        });
      }
      
      // 更新页脚信息
      function updateFooterInfo(pagination) {
        const start = (pagination.current_page - 1) * pagination.per_page + 1;
        const end = Math.min(pagination.current_page * pagination.per_page, pagination.total_records);
        
        document.getElementById('record-range').textContent = `${start}-${end}`;
        document.getElementById('total-records-footer').textContent = pagination.total_records;
      }
      
      // 渲染分页控件
      function renderPaginationControls(pagination) {
        const paginationContainer = document.getElementById('pagination-controls');
        paginationContainer.innerHTML = '';
        
        // 上一页/下一页按钮
        const addPageButton = (icon, page, disabled = false) => {
          const button = document.createElement('button');
          
          if (icon) {
            const iconEl = document.createElement('i');
            iconEl.className = icon;
            button.appendChild(iconEl);
          } else {
            button.textContent = page;
          }
          
          button.disabled = disabled;
          
          if (page === pagination.current_page) {
            button.classList.add('active');
          }
          
          button.addEventListener('click', () => {
            if (!disabled) {
              currentPage = page;
              fetchFinancialRecords();
            }
          });
          
          paginationContainer.appendChild(button);
        };
        
        // 第一页
        addPageButton('fas fa-angle-double-left', 1, currentPage === 1);
        
        // 上一页
        addPageButton('fas fa-angle-left', currentPage - 1, currentPage === 1);
        
        // 当前页附近的分页
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
          addPageButton(null, i);
        }
        
        // 显示当前页两边有省略号
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('button');
          ellipsis.textContent = '...';
          ellipsis.disabled = true;
          paginationContainer.appendChild(ellipsis);
        }
        
        // 最后一页
        if (endPage < totalPages) {
          addPageButton(null, totalPages);
        }
        
        // 下一页
        addPageButton('fas fa-angle-right', currentPage + 1, currentPage === totalPages);
        
        // 最后一页
        addPageButton('fas fa-angle-double-right', totalPages, currentPage === totalPages);
      }
      
      // 表格排序功能
      document.querySelectorAll('.data-table th[data-sort]').forEach(header => {
        header.addEventListener('click', () => {
          const field = header.dataset.sort;
          
          // 如果点击的是同一个字段，则切换排序方向
          if (currentSort.field === field) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
          } else {
            // 否则设置为默认方向
            currentSort = { field, direction: 'desc' };
          }
          
          // 更新表格中所有排序指示器
          document.querySelectorAll('.data-table th i').forEach(icon => {
            icon.className = 'fas fa-sort';
          });
          
          // 更新当前排序字段的指示器
          const icon = header.querySelector('i');
          icon.className = currentSort.direction === 'asc' 
            ? 'fas fa-sort-up' 
            : 'fas fa-sort-down';
          
          fetchFinancialRecords();
        });
      });
      
      // 辅助函数：格式化货币
      function formatCurrency(amount) {
        return new Intl.NumberFormat('zh-CN').format(amount);
      }
      
      // 辅助函数：格式化日期
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        }).replace(/\//g, '-');
      }
      
      // 事件监听器
      document.getElementById('apply-filter').addEventListener('click', () => {
        currentPage = 1;
        fetchFinancialRecords();
      });
      
      document.getElementById('reset-filter').addEventListener('click', () => {
        document.getElementById('search').value = '';
        document.getElementById('payer').selectedIndex = 0;
        document.getElementById('receiver').selectedIndex = 0;
        document.getElementById('type').selectedIndex = 0;
        currentPage = 1;
        fetchFinancialRecords();
      });
      
      document.getElementById('export-data').addEventListener('click', function() {
        alert('CSV导出功能将在后续版本中提供');
      });
    });
  </script>
</body>
</html>
